<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FinanceService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">personal-finance-app</a> &gt; <a href="index.source.html" class="el_package">ru.financeapp.core</a> &gt; <span class="el_source">FinanceService.java</span></div><h1>FinanceService.java</h1><pre class="source lang-java linenums">package ru.financeapp.core;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import ru.financeapp.exceptions.InvalidInputException;
import ru.financeapp.exceptions.UserNotFoundException;
import ru.financeapp.infra.Storage;

public class FinanceService {
    private final UserService userService;

<span class="fc" id="L14">    public FinanceService(UserService userService) {</span>
<span class="fc" id="L15">        this.userService = userService;</span>
<span class="fc" id="L16">    }</span>

    public void addIncome(String category, double amount) {
<span class="fc" id="L19">        validateAmount(amount);</span>
<span class="fc" id="L20">        validateCategory(category);</span>
<span class="fc" id="L21">        Transaction t = new Transaction(Transaction.Type.INCOME, category, amount);</span>
<span class="fc" id="L22">        userService.getCurrentUser().getWallet().addTransaction(t);</span>
<span class="fc" id="L23">        checkNotifications(t);</span>
<span class="fc" id="L24">    }</span>

    public void addExpense(String category, double amount) {
<span class="fc" id="L27">        validateAmount(amount);</span>
<span class="fc" id="L28">        validateCategory(category);</span>
<span class="fc" id="L29">        Transaction t = new Transaction(Transaction.Type.EXPENSE, category, amount);</span>
<span class="fc" id="L30">        userService.getCurrentUser().getWallet().addTransaction(t);</span>
<span class="fc" id="L31">        checkNotifications(t);</span>
<span class="fc" id="L32">    }</span>

    public void setBudget(String category, double amount) {
<span class="fc" id="L35">        validateAmount(amount);</span>
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">        if (amount &lt; 0) throw new InvalidInputException(&quot;Budget cannot be negative&quot;);</span>
<span class="fc" id="L37">        userService.getCurrentUser().getWallet().setBudget(category, amount);</span>
<span class="fc" id="L38">    }</span>

    public double getTotalIncome() {
<span class="fc" id="L41">        return userService.getCurrentUser().getWallet().getTransactions().stream()</span>
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">                .filter(t -&gt; t.getType() == Transaction.Type.INCOME)</span>
<span class="fc" id="L43">                .mapToDouble(Transaction::getAmount)</span>
<span class="fc" id="L44">                .sum();</span>
    }

    public double getTotalExpenses() {
<span class="fc" id="L48">        return userService.getCurrentUser().getWallet().getTransactions().stream()</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">                .filter(t -&gt; t.getType() == Transaction.Type.EXPENSE)</span>
<span class="fc" id="L50">                .mapToDouble(Transaction::getAmount)</span>
<span class="fc" id="L51">                .sum();</span>
    }

    public Map&lt;String, Double&gt; getIncomeByCategories(List&lt;String&gt; categories) {
<span class="nc" id="L55">        return filterByCategories(Transaction.Type.INCOME, categories);</span>
    }

    public Map&lt;String, Double&gt; getExpensesByCategories(List&lt;String&gt; categories) {
<span class="fc" id="L59">        return filterByCategories(Transaction.Type.EXPENSE, categories);</span>
    }

    public double getBudgetRemaining(String category) {
<span class="fc" id="L63">        double budget = userService.getCurrentUser().getWallet().getBudget(category);</span>
<span class="fc" id="L64">        double spent = getExpensesByCategories(List.of(category)).getOrDefault(category, 0.0);</span>
<span class="fc" id="L65">        return budget - spent;</span>
    }

    public boolean isBudgetExceeded(String category) {
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        return getBudgetRemaining(category) &lt; 0;</span>
    }

    public void transfer(String toUsername, double amount) {
<span class="fc" id="L73">        User current = userService.getCurrentUser();</span>
<span class="fc" id="L74">        Storage st = userService.getStorage();</span>
<span class="fc" id="L75">        User toUser = st.findUser(toUsername);</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        if (toUser == null) throw new UserNotFoundException(&quot;Recipient not found: &quot; + toUsername);</span>
<span class="fc" id="L77">        addExpense(&quot;Transfer&quot;, amount);</span>
<span class="fc" id="L78">        toUser.getWallet()</span>
<span class="fc" id="L79">                .addTransaction(new Transaction(Transaction.Type.INCOME, &quot;Transfer&quot;, amount));</span>
<span class="fc" id="L80">        st.saveWallet(toUser);</span>
<span class="fc" id="L81">    }</span>

    private Map&lt;String, Double&gt; filterByCategories(Transaction.Type type, List&lt;String&gt; categories) {
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (categories.isEmpty()) {</span>
<span class="nc" id="L85">            return getAllByType(type);</span>
        }
<span class="fc" id="L87">        Map&lt;String, Double&gt; result = getAllByType(type);</span>
<span class="fc" id="L88">        Map&lt;String, Double&gt; budgets = userService.getCurrentUser().getWallet().getBudgets();</span>
<span class="fc" id="L89">        categories.forEach(</span>
                cat -&gt; {
<span class="pc bpc" id="L91" title="1 of 4 branches missed.">                    if (!result.containsKey(cat) &amp;&amp; !budgets.containsKey(cat)) {</span>
<span class="fc" id="L92">                        System.out.println(</span>
                                &quot;Warning: Category '&quot;
                                        + cat
                                        + &quot;' not found in transactions or budgets.&quot;);
                    }
<span class="fc" id="L97">                });</span>
<span class="fc" id="L98">        return result.entrySet().stream()</span>
<span class="fc" id="L99">                .filter(e -&gt; categories.contains(e.getKey()))</span>
<span class="fc" id="L100">                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</span>
    }

    private Map&lt;String, Double&gt; getAllByType(Transaction.Type type) {
<span class="fc" id="L104">        return userService.getCurrentUser().getWallet().getTransactions().stream()</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">                .filter(t -&gt; t.getType() == type)</span>
<span class="fc" id="L106">                .collect(</span>
<span class="fc" id="L107">                        Collectors.groupingBy(</span>
                                Transaction::getCategory,
<span class="fc" id="L109">                                Collectors.summingDouble(Transaction::getAmount)));</span>
    }

    private void validateAmount(double amount) {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (amount &lt;= 0) throw new InvalidInputException(&quot;Amount must be positive&quot;);</span>
<span class="fc" id="L114">    }</span>

    private void validateCategory(String category) {
<span class="fc bfc" id="L117" title="All 2 branches covered.">        if (category.isEmpty()) throw new InvalidInputException(&quot;Category cannot be empty&quot;);</span>
<span class="fc" id="L118">    }</span>

    private void checkNotifications(Transaction t) {
<span class="fc bfc" id="L121" title="All 2 branches covered.">        if (t.getType() == Transaction.Type.EXPENSE) {</span>
<span class="fc" id="L122">            double remaining = getBudgetRemaining(t.getCategory());</span>
<span class="fc" id="L123">            double budget = userService.getCurrentUser().getWallet().getBudget(t.getCategory());</span>
<span class="pc bpc" id="L124" title="3 of 4 branches missed.">            if (budget &gt; 0 &amp;&amp; remaining &lt; 0.8 * budget) {</span>
<span class="nc" id="L125">                System.out.println(&quot;Warning: 80% of budget for '&quot; + t.getCategory() + &quot;' used!&quot;);</span>
            }
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">            if (remaining &lt; 0) {</span>
<span class="nc" id="L128">                System.out.println(&quot;Alert: Budget exceeded for '&quot; + t.getCategory() + &quot;'!&quot;);</span>
            }
        }
<span class="fc" id="L131">        double balance = getTotalIncome() - getTotalExpenses();</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if (balance == 0) {</span>
<span class="fc" id="L133">            System.out.println(&quot;Warning: Balance is zero!&quot;);</span>
        }
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (getTotalExpenses() &gt; getTotalIncome()) {</span>
<span class="nc" id="L136">            System.out.println(&quot;Alert: Expenses exceed income!&quot;);</span>
        }
<span class="fc" id="L138">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>